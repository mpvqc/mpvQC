# Supposed to be called at repository root level - copied during CI build to root level
#
# To build:
#   make
#   flatpak-builder build-dir com.github.mpvqc.mpvQC.yml --force-clean
#   flatpak-builder run build-dir com.github.mpvqc.mpvQC.yml mpvQC

app-id: com.github.mpvqc.mpvQC
runtime: org.freedesktop.Platform
runtime-version: '23.08'
sdk: org.freedesktop.Sdk
command: mpvQC

finish-args:
  - --device=dri
  - --filesystem=home
  - --share=ipc
  - --socket=wayland
  - --socket=fallback-x11
  - --socket=pulseaudio
  - --env=LC_ALL=C  # todo: should work but doesn't: --env=LC_NUMERIC=C

build-options:
  cflags: -O2 -g
  cxxflags: -O2 -g
  env:
    V: '1'

cleanup:
  - /include
  - /lib/debug
  - /lib/pkgconfig
  - /lib/python3.12/site-packages/PySide6/examples
  - /lib/python3.12/site-packages/PySide6/lupdate
  - /lib/python3.12/site-packages/PySide6/assistant
  - /lib/python3.12/site-packages/PySide6/qmllint
  - /lib/python3.12/site-packages/PySide6/linguist
  - /lib/python3.12/site-packages/PySide6/Qt/lib/libQt6WebEngineCore.so.6
  - /lib/python3.12/site-packages/PySide6/Qt/translations/qtwebengine_locales
  - /lib/python3.12/site-packages/PySide6/Qt/resources
  - /man
  - /share/doc
  - /share/gtk-doc
  - /share/man
  - '*.la'
  - '*.a'

modules:
  - name: libmpv
    cleanup:
      - /share/bash-completion
      - /share/zsh
      - /share/doc
      - /share/icons
      - /share/applications
    buildsystem: meson
    config-opts:
      - -Dlibmpv=true
      - -Dlua=enabled
      - -Ddebug=false
      - -Dbuild-date=false
      - -Dalsa=disabled
      - -Dmanpage-build=disabled
    sources:
      - type: archive
        url: https://github.com/mpv-player/mpv/archive/refs/tags/v0.36.0.tar.gz
        sha256: 29abc44f8ebee013bb2f9fe14d80b30db19b534c679056e4851ceadf5a5e8bf6
    modules:
      - name: luajit
        no-autogen: true
        cleanup:
          - /bin
          - /lib/*.a
          - /include
          - /lib/pkgconfig
          - /share/man
        sources:
          - type: archive
            url: https://luajit.org/download/LuaJIT-2.1.0-beta3.tar.gz
            sha256: 1ad2e34b111c802f9d0cdf019e986909123237a28c746b21295b63c9e785d9c3
          - type: shell
            commands:
              - sed -i 's|/usr/local|/app|' ./Makefile

      - name: libXpresent
        buildsystem: autotools
        sources:
          - type: archive
            url: https://xorg.freedesktop.org/archive/individual/lib/libXpresent-1.0.1.tar.xz
            sha256: b964df9e5a066daa5e08d2dc82692c57ca27d00b8cc257e8e960c9f1cf26231b

      - name: libv4l2
        cleanup:
          - /sbin
          - /bin
          - /include
          - /lib/*.la
          - /lib/*/*.la
          - /lib*/*/*/*.la
          - /lib/pkgconfig
          - /share/man
        config-opts:
          - --disable-static
          - --disable-bpf
          - --with-udevdir=/app/lib/udev
        sources:
          - type: archive
            url: https://linuxtv.org/downloads/v4l-utils/v4l-utils-1.24.1.tar.bz2
            sha256: cbb7fe8a6307f5ce533a05cded70bb93c3ba06395ab9b6d007eb53b75d805f5b

      - name: nv-codec-headers
        cleanup:
          - '*'
        no-autogen: true
        make-install-args:
          - PREFIX=/app
        sources:
          - type: archive
            url: https://github.com/FFmpeg/nv-codec-headers/archive/refs/tags/n12.0.16.0.tar.gz
            sha256: 2a1533b65f55f9da52956faf0627ed3b74868ac0c7f269990edd21369113b48f

      - name: ffmpeg
        cleanup:
          - /share/ffmpeg/examples
        config-opts:
          - --disable-debug
          - --disable-doc
          - --disable-programs
          - --disable-static
          - --disable-encoders
          - --disable-muxers
          - --enable-shared
          - --enable-gnutls
          - --enable-gpl
          - --enable-version3
          - --enable-encoder=png,libwebp,libjxl
          - --enable-libv4l2
          - --enable-libdav1d
          - --enable-libfontconfig
          - --enable-libfreetype
          - --enable-libopus
          - --enable-librsvg
          - --enable-libvpx
          - --enable-libmp3lame
          - --enable-libwebp
          - --enable-libjxl
        sources:
          - type: archive
            url: https://ffmpeg.org/releases/ffmpeg-6.0.tar.gz
            sha256: f4ccf961403752c93961927715f524576d1f4dd02cd76d8c76aed3bbe6686656
            x-checker-data:
              type: anitya
              project-id: 5405
              stable-only: true
              url-template: https://ffmpeg.org/releases/ffmpeg-$version.tar.gz
        modules:
          - name: libjxl
            buildsystem: cmake-ninja
            config-opts:
              - -DBUILD_TESTING=OFF
              - -DJPEGXL_ENABLE_BENCHMARK=OFF
              - -DJPEGXL_ENABLE_COVERAGE=OFF
              - -DJPEGXL_ENABLE_EXAMPLES=OFF
              - -DJPEGXL_ENABLE_FUZZERS=OFF
              - -DJPEGXL_ENABLE_JNI=OFF
              - -DJPEGXL_ENABLE_SJPEG=OFF
              - -DJPEGXL_ENABLE_SKCMS=OFF
              - -DJPEGXL_ENABLE_TOOLS=OFF
              - -DJPEGXL_ENABLE_VIEWERS=OFF
            sources:
              - type: archive
                url: https://github.com/libjxl/libjxl/archive/refs/tags/v0.9-snapshot.tar.gz
                sha256: 2177f72fb141dce69d071c24864fbebc9aa7133e8dda212783609e1996024078
                x-checker-data:
                  type: anitya
                  project-id: 232764
                  stable-only: true
                  url-template: https://github.com/libjxl/libjxl/archive/refs/tags/v$version.tar.gz
            modules:
              - name: highway
                buildsystem: cmake-ninja
                config-opts:
                  - -DCMAKE_BUILD_TYPE=RelWithDebInfo
                  - -DBUILD_TESTING=OFF
                  - -DBUILD_SHARED_LIBS=ON
                sources:
                  - type: archive
                    url: https://github.com/google/highway/archive/refs/tags/1.0.7.tar.gz
                    sha256: 5434488108186c170a5e2fca5e3c9b6ef59a1caa4d520b008a9b8be6b8abe6c5
                    x-checker-data:
                      type: anitya
                      project-id: 205809
                      stable-only: true
                      url-template: https://github.com/google/highway/archive/refs/tags/$version.tar.gz

      - name: libass
        cleanup:
          - /include
          - /lib/*.la
          - /lib/pkgconfig
        config-opts:
          - --disable-static
        sources:
          - type: archive
            url: https://github.com/libass/libass/releases/download/0.17.1/libass-0.17.1.tar.gz
            sha256: d653be97198a0543c69111122173c41a99e0b91426f9e17f06a858982c2fb03d

      - name: uchardet
        buildsystem: cmake-ninja
        cleanup:
          - /bin
          - /include
          - /lib/pkgconfig
          - /share/man
        config-opts:
          - -DCMAKE_BUILD_TYPE=Release
          - -DBUILD_STATIC=0
        sources:
          - type: archive
            url: https://www.freedesktop.org/software/uchardet/releases/uchardet-0.0.8.tar.xz
            sha256: e97a60cfc00a1c147a674b097bb1422abd9fa78a2d9ce3f3fdcc2e78a34ac5f0

  - name: python
    sources:
      - type: archive
        url: https://www.python.org/ftp/python/3.12.0/Python-3.12.0.tar.xz
        sha256: 795c34f44df45a0e9b9710c8c71c15c671871524cd412ca14def212e8ccb155d

  # https://github.com/flathub/io.qt.qtwebengine.BaseApp/tree/branch/6.2/krb5
  - name: krb5
    subdir: src
    cleanup:
      - /bin
      - /share/et
      - /share/examples
      - /share/man
    config-opts:
      - --localstatedir=/var/lib
      - --sbindir=${FLATPAK_DEST}/bin
      - --disable-rpath
      - --disable-static
    post-install:
      - install -Dm644 ../krb5.conf -t ${FLATPAK_DEST}/etc/
    sources:
      - type: file
        path: build-aux/linux/krb5.conf
      - type: archive
        url: https://kerberos.org/dist/krb5/1.20/krb5-1.20.1.tar.gz
        sha256: 704aed49b19eb5a7178b34b2873620ec299db08752d6a8574f95d41879ab8851

  - name: python3-inject
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "inject>=5.2.0" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/62/1f/73a1064babd1f50be9b740a2ac5bf355fd6be2b914d68455268209f78829/inject-5.2.0-py2.py3-none-any.whl
        sha256: 0eaed0083c180b1dd3dba169dfa2b7b077fc0d65f454b4cbed1866243cc231a0
  - name: python3-PySide6
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "PySide6>=6.5.0" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/14/cd/f8117f92430564af4cb60bc38d93de8dcb1d051c955cf0a62e6563fe7f55/PySide6-6.6.0-cp38-abi3-manylinux_2_28_x86_64.whl
        sha256: d487eab0f9bfc5c9141b474093e16207ff48cd9335e6465a01deb8dff0693fbc
      - type: file
        url: https://files.pythonhosted.org/packages/6b/eb/72572b8db7713305b6a15ea7aa04bd7240cd9d84c33cc790218532fc0f43/shiboken6-6.6.0-cp38-abi3-manylinux_2_28_x86_64.whl
        sha256: 456b89fb4b323e0c5002d92e4d346b48bb4e709db801208df8a0d6b4f5efc33d
      - type: file
        url: https://files.pythonhosted.org/packages/e2/f0/09e8e38a51f705eecda1202cb51a9fcc7affb0f9fd3be44bf58ce25528dc/PySide6_Essentials-6.6.0-cp38-abi3-manylinux_2_28_x86_64.whl
        sha256: 60284641619f964e1cb4d53cf3169d7a385e0378b74edb75610918d2aea1c4e5
      - type: file
        url: https://files.pythonhosted.org/packages/d9/37/94576a9a1c4070652d508e277642e896693d49d83fc329949c13de19cef5/PySide6_Addons-6.6.0-cp38-abi3-manylinux_2_28_x86_64.whl
        sha256: 5c56e963b841aeaacbc9ca8ca34df45308818dbd6fc59faa2b5a00a299e9892b
  - name: python3-mpv
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "mpv>=1.0.5" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/10/2d/691b5c80a5faa756856740e2bcd17b4b3a07cf11fa8daf07b9952d411251/mpv-1.0.5-py3-none-any.whl
        sha256: 52f3c804bd8aa18b941d220b2d8a3484a1406bd9aeae003e277671c6ad054b38

  - name: mpvQC
    buildsystem: simple
    build-commands:
      - mkdir -p /app/app-directory
      - cp -r mpvqc /app/app-directory
      - install -D main.py /app/app-directory
      - install -Dm644 com.github.mpvqc.mpvQC.svg /app/share/icons/hicolor/scalable/apps/com.github.mpvqc.mpvQC.svg
      - install -Dm644 com.github.mpvqc.mpvQC.desktop /app/share/applications/com.github.mpvqc.mpvQC.desktop
      - install -Dm644 com.github.mpvqc.mpvQC.metainfo.xml -t /app/share/metainfo
      - sed -i 's|/usr/bin/env python|/app/bin/python3|' /app/app-directory/main.py
      - ln -s /app/app-directory/main.py /app/bin/mpvQC
    sources:
      - type: dir
        path: build/release
      - type: dir
        path: build-aux/linux
